# variables:
#   $MODULES_REGISTRY - base URL for the registry, e.g., registry.example.com
#   $MODULES_REGISTRY_PATH - registry path to the module source, e.g., /deckhouse/modules
#   $MODULES_MODULE_NAME (Optional) - module name, by default it is equal to the project name


.build:
  stage: build
  script:
    - werf build --save-build-report --build-report-path images_tags_werf.json
    # Bundle image
    - |
      IMAGE_SRC="$(jq -r '.Images."bundle".DockerImageName' images_tags_werf.json)"
      IMAGE_DST="$(jq -r '.Images.bundle.DockerRepo' images_tags_werf.json):${CI_COMMIT_REF_NAME}"
      
      echo "✨ Pushing ${IMAGE_SRC} to ${IMAGE_DST}"
      crane copy ${IMAGE_SRC} ${IMAGE_DST}
    # Release-channel image
    - |
      IMAGE_SRC="$(jq -r '.Images."release-channel-version".DockerImageName' images_tags_werf.json)"
      IMAGE_DST="$(jq -r '.Images."release-channel-version".DockerRepo' images_tags_werf.json)/release:${CI_COMMIT_REF_NAME}"
      
      echo "✨ Pushing ${IMAGE_SRC} to ${IMAGE_DST}"
      crane copy ${IMAGE_SRC} ${IMAGE_DST}
    # Register module
    - |
      echo "✨ Register the module ${MODULES_MODULE_NAME}"
      crane append \
        --oci-empty-base \
        --new_layer "" \
        --new_tag "${MODULES_REGISTRY}/${MODULES_REGISTRY_PATH}:${MODULES_MODULE_NAME}"
  only:
    - tags
    - branches
  except:
    - main
