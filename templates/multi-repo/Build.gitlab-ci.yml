# variables:
#   Variables for sign (inherited from Setup.gitlab-ci.yml):
#   WERF_SIGN_MANIFEST - enable image signing
#   WERF_BSIGN_ELF_FILES - enable binary signing
#   WERF_ANNOTATE_LAYERS_WITH_DM_VERITY_ROOT_HASH - add dm-verity hashes to layers
#   WERF_ELF_PGP_PRIVATE_KEY_FINGERPRINT - GPG key fingerprint
#   WERF_ELF_PGP_PRIVATE_KEY_PASSPHRASE - GPG key passphrase
#   VAULT_ADDR - Vault address
#   WERF_SIGN_CERT - certificate for signing images
#   WERF_SIGN_INTERMEDIATES - intermediate certificates
#   WERF_SIGN_KEY - private key for signing

.build:
  stage: build
  rules:
    - !reference [.default_rules, rules]
  before_script:
    - !reference [.setup, before_script]
  script:
    # Bundle image
    - |
      # Check if signing keys are present
      if [[ -n "${WERF_SIGN_VERSION}" && "${WERF_SIGN_MANIFEST}" == "true" ]]; then
        if [[ -n "${WERF_SIGN_CERT}" && -n "${WERF_SIGN_KEY}" ]]; then
          echo "✅ Image signing is enabled and configured"
        else
          echo "⚠️ WARNING: Image signing is enabled but certificates are not configured"
        fi
      fi

      if [[ -n "${WERF_SIGN_VERSION}" && "${WERF_BSIGN_ELF_FILES}" == "1" ]]; then
        if [[ -n "${WERF_ELF_PGP_PRIVATE_KEY_FINGERPRINT}" ]]; then
          echo "✅ Binary signing is enabled and configured"
        else
          echo "⚠️ WARNING: Binary signing is enabled but GPG key is not configured"
        fi
      fi

    # Build images
    - |
      werf build \
        --save-build-report --build-report-path images_tags_werf.json
  artifacts:
    paths:
      - images_tags_werf.json
    expire_in: "30 days"

.svace_rules_mr:
  rules:
    - if: '$CI_MERGE_REQUEST_LABELS =~ /(^|,)analyze\/svace(,|$)/'
      variables:
        SVACE_ENABLED: "true"

.svace_rules_manual:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web" && $SVACE_ENABLED == "true" && $CI_COMMIT_BRANCH
      variables:
        SVACE_ENABLED: "true"

.svace_rules_schedule:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SVACE_ENABLED == "true" && $CI_COMMIT_BRANCH
      variables:
        SVACE_ENABLED: "true"