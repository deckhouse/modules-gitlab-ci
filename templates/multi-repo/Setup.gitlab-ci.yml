variables:
  ##############################
  # User default settings
  ##############################

  MODULES_MODULE_NAME: "${CI_PROJECT_NAME}"
  MODULES_MODULE_TAG: ${CI_COMMIT_REF_NAME}
  # Enable auto-cleanup job by default.
  # `Auto cleanup` job is run randomly, only if current second is divisible by 10
  AUTO_CLEANUP:
    value: "true"
    description: "`Auto cleanup` job is run randomly (if enabled), only if current second is divisible by 10"

  ##############################
  # Internal default settings
  ##############################
  BASE_IMAGES_VERSION: v0.2
  FORCE_CI:
    value: "false"
    description: "Set to true if need force run workflow"

  # use module's container registry (on Gitlab) as werf's intermediate/cache images registry (repo with all build-time artifacts (garbage))
  WERF_REPO: ${CI_REGISTRY_IMAGE}/${MODULES_MODULE_NAME}

stages:
  - lint
  - cleanup
  - build
  - deploy

.default_rules:
  rules:
    # run if $FORCE_CI variable is set to true
    - if: $FORCE_CI == "true" || $FORCE_CI == "1"
    # run if there is a tag defined (module release workflow)
    - if: $CI_COMMIT_TAG
    # run if this is a merge request event
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    # run when push to default (main/master) branch (for example, when merge request is merged to `master` branch)
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # run when new branch is created and there are no opened merge requests for this branch and no commits to this branch yet (completely new branch from master/main)
    # this rule is required for job `Publish merge request to DEV` to work properly
    # - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH && ($CI_MERGE_REQUEST_IID == null || $CI_MERGE_REQUEST_IID == "") && $CI_COMMIT_BEFORE_SHA == "0000000000000000000000000000000000000000"
    # DO NOT run if this is a push to a branch and there are open merge requests (remove duplicated `branch` pipeline)
    # - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
    #   when: never
    # DO NOT run if this is a push (commits) to a branch (regardless of opened merge requests)
    - if: $CI_COMMIT_BRANCH
      when: never

.setup:
  before_script:
    # Setup trdl
    - |
      trdl_version=$(curl -s https://tuf.trdl.dev/targets/channels/0/stable)
      curl -sSLO "https://tuf.trdl.dev/targets/releases/$trdl_version/linux-amd64/bin/trdl"
      install -D trdl ~/bin/trdl
      rm trdl
      export PATH=$PATH:~/bin

    # Setup werf
    - |
      trdl add werf https://tuf.werf.io 1 b7ff6bcbe598e072a86d595a3621924c8612c7e6dc6a82e919abe89707d7e3f468e616b5635630680dd1e98fc362ae5051728406700e6274c5ed1ad92bea52a2
      source $(trdl use werf ${WERF_VERSION:-1.2 stable})
      source $(werf ci-env gitlab --as-file)

      # Login to gitlab registry by default
      if [[ "x${MODULES_REGISTRY}" == "x" ]]; then
        MODULES_REGISTRY="${CI_REGISTRY}"
      fi
      if [[ "x${MODULES_REGISTRY_LOGIN}" == "x" ]]; then
        MODULES_REGISTRY_LOGIN="${CI_REGISTRY_USER}"
      fi
      if [[ "x${MODULES_REGISTRY_PASSWORD}" == "x" ]]; then
        MODULES_REGISTRY_PASSWORD="${CI_REGISTRY_PASSWORD}"
      fi
      werf cr login -u ${MODULES_REGISTRY_LOGIN} -p ${MODULES_REGISTRY_PASSWORD} ${MODULES_REGISTRY}

    # Setup dmt
    - |
      trdl add dmt https://trrr.flant.dev/trdl-dmt/ 0 e77d785600a8c8612b84b93a5a2e4c48188d68f7478356d0708213e928bf67b024ed412e702dc32930da5c5bfc9b1c44be3ee7a292f923327815c91c6c3c3833
      source $(trdl use dmt 0 stable)

    # Download base images yaml file
    - env | grep BASE_IMAGES_VERSION
    - curl --fail -sSLO https://fox.flant.com/api/v4/projects/deckhouse%2Fbase-images/packages/generic/base_images/${BASE_IMAGES_VERSION}/base_images.yml
