stages:
  - antivirus_scan

variables:
  AV_SCAN_MODULE:
    description: "Enable antivirus scan"
    value: "false"
    options:
      - "true"
      - "false"
  AV_SCAN_RESULTS_DIR: "scans"
  AV_ACTIVE_RELEASES_TO_SCAN: "3"
  AV_SCAN_BRANCH:
    description: "If there is no empty value, then the scan will be started only for the value from this variable"
    value: ""
  AV_EDITIONS: "fe"
  AV_MODULE_NAME: ${MODULES_MODULE_NAME}
  AV_PROD_REGISTRY: ${PROD_REGISTRY}
  AV_DEV_REGISTRY: ${DEV_REGISTRY}
  AV_N8N_LOOP_NOTIFIER_URL: ${N8N_LOOP_NOTIFIER_URL}

Antivirus scan get tags:
  stage: antivirus_scan
  tags:
    - docker
  image: debian:bookworm-slim
  before_script:
    - apt-get update && apt-get install -y git
  script:
    - |
      export TAGS
      if [[ -n "${AV_SCAN_BRANCH}" ]]; then
        TAGS="${AV_SCAN_BRANCH}"
      else
        TAGS=$(git ls-remote --tags origin | grep -F tags/v | awk -F '/' '{print $3}' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$')
        TAGS_TO_SCAN=$(echo $TAGS | tr ' ' '\n' | sed 's/^v//' | sort -t. -k1,1n -k2,2n -k3,3n | awk -F. '{
          key = $1 "." $2 # major.minor
          if (key != prev && prev != "") {
            print "v" prev "." maxp
          }
          if (key != prev) {
            prev = key
            maxp = $3
          } else if ($3 > maxp) {
            maxp = $3
          }
        }
        END { if (prev != "") print "v" prev "." maxp }' | tail -${AV_ACTIVE_RELEASES_TO_SCAN})
        TAGS=""
        for edition in ${AV_EDITIONS}
        do
          for tag in $TAGS_TO_SCAN
          do
            TAGS+=$'\n'"$edition:$tag"
          done
        done
        TAGS+=$'\n'"main"
      fi

      echo "Tags to scan:"
      echo "$TAGS"

      cat <<OUTER > generate-child-pipeline.sh
      #!/bin/bash

      AV_ANTIVIRUS_NAME=\$1
      AV_ANTIVIRUS_PATH=\$2

      cat <<'INNER' > child-pipeline-\${AV_ANTIVIRUS_NAME}.yml
      stages:
          - antivirus_scan

      variables:
          AV_SCAN_RESULTS_DIR: "${AV_SCAN_RESULTS_DIR}"

      \${AV_ANTIVIRUS_NAME}-scan:
          stage: antivirus_scan
          tags:
            - docker
          parallel:
            matrix:
              - TAG: [\${TAGS_ARRAY}]
          script:
            - |
              echo "Processing \$TAG"
              export branch="\$TAG"
              ref=\$(echo "\$branch" | awk -F':' '{ print \$2 }' | tr -d '\n')
              if [ -z "\${ref}" ]; then
                ref=\$(echo "\$branch" | tr -d '\n')
              fi
              ref_sanitized=\$(echo "\${ref}" | sed 's/[.\/]/-/g')
              SCAN_TIME=\$(date '+%s')
              SCAN_ID="\$SCAN_TIME-\$CI_PIPELINE_ID-\${ref_sanitized}"
              
              if [[ "\${ref}" =~ ^v?[0-9]+.[0-9]+.[0-9]+$ ]]; then
                echo "registry read"
                edition=\$(echo "\$branch" | tr -d '\n' | awk -F':' '{ print \$1 }')
                SCAN_ID+="-\${edition}"
                registry_image_path="/deckhouse/\${edition}/modules/${AV_MODULE_NAME}"
                registry_host=$AV_PROD_REGISTRY
              else
                echo "registry dev"
                registry_image_path="/sys/deckhouse-oss/modules/${AV_MODULE_NAME}"
                registry_host=$AV_DEV_REGISTRY
              fi
              
              CONTAINER_NAME=registry_\${AV_ANTIVIRUS_NAME}
              SCAN_ID+="-\$CONTAINER_NAME"
              echo "scan_id=\${SCAN_ID}"
              
              docker exec \${CONTAINER_NAME} scanner \${ref} \${registry_host}\${registry_image_path} \${SCAN_ID} module
              
              mkdir -p \${AV_SCAN_RESULTS_DIR}/\${SCAN_ID}
              docker cp \${CONTAINER_NAME}:/\${AV_ANTIVIRUS_PATH}/scans/\${SCAN_ID}/scan_results_clean.md ./\${AV_SCAN_RESULTS_DIR}/\${SCAN_ID}/scan_results_clean.md
              docker cp \${CONTAINER_NAME}:/\${AV_ANTIVIRUS_PATH}/scans/\${SCAN_ID}/scan_results_threats.md ./\${AV_SCAN_RESULTS_DIR}/\${SCAN_ID}/scan_results_threats.md
              
              if [ -f \${AV_SCAN_RESULTS_DIR}/\${SCAN_ID}/scan_results_threats.md ]; then
                THREAT_COUNT=\$(sed -n 's/.*Images with threats | \([0-9]\+\) |.*/\1/p' \${AV_SCAN_RESULTS_DIR}/\${SCAN_ID}/scan_results_threats.md | head -1)
                ERRORS_COUNT=\$(sed -n 's/.*Errors | \([0-9]\+\) |.*/\1/p' \${AV_SCAN_RESULTS_DIR}/\${SCAN_ID}/scan_results_threats.md | head -1)
                if [ -n "\$THREAT_COUNT" ] && [ "\$THREAT_COUNT" -gt 0 ]; then
                  echo "‚ùå THREATS DETECTED: \$THREAT_COUNT images contain threats!"
                  exit 1
                elif [ -n "\$ERRORS_COUNT" ] && [ "\$ERRORS_COUNT" -gt 0 ]; then
                  echo "‚ùå ERRORS DETECTED: \$ERRORS_COUNT!"
                  exit 1
                else
                  echo "‚úÖ No threats detected (\$THREAT_COUNT)"
                fi
              else
                echo "‚ö†Ô∏è The scan results file was not found"
                exit 1
              fi
              echo "‚úÖ \${CONTAINER_NAME} scan completed for \$branch"
          artifacts:
            paths:
              - \${AV_SCAN_RESULTS_DIR}/
            expire_in: 1 week
            when: always
      INNER
      sed -i -e "s/\\\${AV_ANTIVIRUS_NAME}/\${AV_ANTIVIRUS_NAME}/g" child-pipeline-\${AV_ANTIVIRUS_NAME}.yml
      sed -i -e "s/\\\${AV_ANTIVIRUS_PATH}/\${AV_ANTIVIRUS_PATH}/g" child-pipeline-\${AV_ANTIVIRUS_NAME}.yml
      sed -i -e 's/\\\${TAGS_ARRAY}/$(echo "$TAGS" | grep -v '^$' | sed 's/^/"/;s/$/"/' | paste -sd,)/g' child-pipeline-\${AV_ANTIVIRUS_NAME}.yml
      OUTER
      chmod +x ./generate-child-pipeline.sh
      cat generate-child-pipeline.sh

      ./generate-child-pipeline.sh drweb drweb
      ./generate-child-pipeline.sh kaspersky antivirus
      cat child-pipeline-drweb.yml
      cat child-pipeline-kaspersky.yml
  rules:
    - if: '$AV_SCAN_MODULE != "true"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  artifacts:
    paths:
      - child-pipeline-drweb.yml
      - child-pipeline-kaspersky.yml

Antivirus scan trigger:
  stage: antivirus_scan
  needs: ["Antivirus scan get tags"]
  rules:
    - if: '$AV_SCAN_MODULE != "true"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
  trigger:
    include:
      - artifact: child-pipeline-drweb.yml
        job: "Antivirus scan get tags"
      - artifact: child-pipeline-kaspersky.yml
        job: "Antivirus scan get tags"
    strategy: depend

notify-failure:
  stage: antivirus_scan
  tags:
    - docker
  image: debian:bookworm-slim
  before_script:
    - apt-get update && apt-get install -y curl jq
  rules:
    - when: on_failure
  needs:
    - job: Antivirus scan trigger
      optional: true
    - job: Antivirus scan get tags
      optional: true
  script:
    - |
      set -euo pipefail

      API="${CI_API_V4_URL}"
      PROJECT_ID="${CI_PROJECT_ID}"
      PIPELINE_ID="${CI_PIPELINE_ID}"

      # auth: prefer CI_JOB_TOKEN, fallback to personal/project token
      AUTH_HEADER=()
      if [[ -n "${CI_JOB_TOKEN:-}" ]]; then
        AUTH_HEADER=(-H "JOB-TOKEN: ${CI_JOB_TOKEN}")
      elif [[ -n "${GITLAB_API_TOKEN:-}" ]]; then
        AUTH_HEADER=(-H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}")
      else
        echo "No CI_JOB_TOKEN or GITLAB_API_TOKEN available"
        exit 1
      fi

      # 1) –ù–∞–π—Ç–∏ bridge job "Antivirus scan trigger" –∏ –≤—ã—Ç–∞—â–∏—Ç—å downstream_pipeline.id
      BRIDGES_JSON="$(curl -sf "${AUTH_HEADER[@]}" \
        "${API}/projects/${PROJECT_ID}/pipelines/${PIPELINE_ID}/bridges?per_page=100")"

      DOWNSTREAM_ID="$(echo "${BRIDGES_JSON}" | jq -r '
        .[] | select(.name=="Antivirus scan trigger") | .downstream_pipeline.id // empty
      ')"

      if [[ -z "${DOWNSTREAM_ID}" ]]; then
        echo "Downstream pipeline id not found for bridge 'Antivirus scan trigger'"
        # –§–æ–ª–ª–±–µ–∫: –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –æ–±—â–∏–π –∞–ª–µ—Ä—Ç
        DOWNSTREAM_URL="${CI_PIPELINE_URL}"
      else
        DOWNSTREAM_URL="${CI_PROJECT_URL}/-/pipelines/${DOWNSTREAM_ID}"
      fi

      # 2) –ï—Å–ª–∏ –µ—Å—Ç—å downstream ‚Äî –∑–∞–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã job-–æ–≤ –≤ child pipeline
      FAILED_LIST=""
      if [[ -n "${DOWNSTREAM_ID}" ]]; then
        JOBS_JSON="$(curl -sf "${AUTH_HEADER[@]}" \
          "${API}/projects/${PROJECT_ID}/pipelines/${DOWNSTREAM_ID}/jobs?per_page=200")"

        # –ë–µ—Ä—ë–º –∏–º–µ–Ω–Ω–æ scan –¥–∂–æ–±—ã; —É—á–∏—Ç—ã–≤–∞–µ–º failed/canceled
        FAILED_LIST="$(echo "${JOBS_JSON}" | jq -r '
          [ .[]
            | select(.name|test("-scan$"))
            | select(.status=="failed" or .status=="canceled")
            | "- \(.name) (status: \(.status)) \(.web_url)"
          ] | .[]?
        ')"
      fi

      if [[ -z "${FAILED_LIST}" ]]; then
        FAILED_LIST="- (–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ø–∞–≤—à–∏–µ job‚Äô—ã; –ø—Ä–æ–≤–µ—Ä—å—Ç–µ pipeline/child pipeline)"
      fi

      # 3) –°–æ–±—Ä–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ markdown-–∫–∞–ø—Ä–∏–∑–æ–≤ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
      MSG=$(jq -n --arg pipeline "${CI_PIPELINE_URL}" \
                 --arg child "${DOWNSTREAM_URL}" \
                 --arg failed "${FAILED_LIST}" '
        "üõë GitLab Antivirus Scan Failed\n\n" +
        "Failed jobs:\n" + $failed + "\n\n" +
        "Pipeline: " + $pipeline + "\n" +
        "Child pipeline: " + $child
      ' -r)

      # 4) –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ n8n
      curl -sf -L -X POST "$AV_N8N_LOOP_NOTIFIER_URL" \
        -H "Content-Type: application/json" \
        --data "$(jq -n --arg type "ci_fail" --arg message "$MSG" '{type:$type,message:$message}')"